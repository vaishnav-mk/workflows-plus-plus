// Bundle MCP-related dependencies into single-file modules for deployment.
//
// This script is intended to be run in a Node environment (e.g. via
//   npm run bundle-mcp
// or from deployment helpers like scripts/test-deploy.ts).
//
// It produces:
//   bundles/agents/agents.mcp.bundle.mjs
//   bundles/mcp/mcp-sdk.bundle.mjs
//   src/services/deployment/mcp-bundles.generated.ts (string-embedded bundle modules)

/* eslint-disable @typescript-eslint/no-var-requires */
const path = require("node:path");
const fs = require("node:fs");
const esbuild = require("esbuild");

async function ensureDir(p) {
  fs.mkdirSync(p, { recursive: true });
}

async function bundleAgentsMcp(rootDir) {
  const entry = path.join(
    rootDir,
    "node_modules",
    "agents",
    "dist",
    "mcp",
    "index.js"
  );

  const outDir = path.join(rootDir, "bundles", "agents");
  await ensureDir(outDir);

  const outfile = path.join(outDir, "agents.mcp.bundle.mjs");

  console.log("[bundle-mcp] Bundling agents MCP entry:", entry);
  await esbuild.build({
    entryPoints: [entry],
    bundle: true,
    format: "esm",
    platform: "node",
    outfile,
    minify: true,
    external: ["cloudflare:*"],
  });
  console.log("[bundle-mcp] Wrote", outfile);
}

async function bundleMcpSdk(rootDir) {
  const entry = path.join(
    rootDir,
    "node_modules",
    "@modelcontextprotocol",
    "sdk",
    "dist",
    "esm",
    "server",
    "mcp.js"
  );

  const outDir = path.join(rootDir, "bundles", "mcp");
  await ensureDir(outDir);

  const outfile = path.join(outDir, "mcp-sdk.bundle.mjs");

  console.log("[bundle-mcp] Bundling MCP SDK server entry:", entry);
  await esbuild.build({
    entryPoints: [entry],
    bundle: true,
    format: "esm",
    platform: "node",
    outfile,
    minify: true,
  });
  console.log("[bundle-mcp] Wrote", outfile);
}

function writeGeneratedTs(rootDir) {
  const agentsPath = path.join(rootDir, "bundles", "agents", "agents.mcp.bundle.mjs");
  const mcpSdkPath = path.join(rootDir, "bundles", "mcp", "mcp-sdk.bundle.mjs");

  const agentsCode = fs.readFileSync(agentsPath, "utf8");
  const mcpSdkCode = fs.readFileSync(mcpSdkPath, "utf8");

  const outDir = path.join(rootDir, "src", "services", "deployment");
  ensureDir(outDir);
  const outFile = path.join(outDir, "mcp-bundles.generated.ts");

  const fileContents = `// AUTO-GENERATED by scripts/bundle-mcp.js. DO NOT EDIT BY HAND.
// Contains string-embedded versions of the MCP-related bundles so that the
// deployment worker can attach them as additional modules without using fs.

export interface EmbeddedModule {
  name: string;
  content: string;
}

export const MCP_EMBEDDED_MODULES: EmbeddedModule[] = [
  {
    name: "bundles/agents/agents.mcp.bundle.mjs",
    content: ${JSON.stringify(agentsCode)}
  },
  {
    name: "bundles/mcp/mcp-sdk.bundle.mjs",
    content: ${JSON.stringify(mcpSdkCode)}
  }
];
`;

  fs.writeFileSync(outFile, fileContents, "utf8");
  console.log("[bundle-mcp] Wrote generated TS module:", outFile);
}

async function main() {
  const rootDir = process.cwd();
  try {
    console.log("[bundle-mcp] Using project root:", rootDir);
    await bundleAgentsMcp(rootDir);
    await bundleMcpSdk(rootDir);
    writeGeneratedTs(rootDir);
    console.log("[bundle-mcp] MCP bundles and generated TS module built successfully.");
  } catch (err) {
    console.error("[bundle-mcp] MCP bundling failed:", err);
    process.exit(1);
  }
}

main();


